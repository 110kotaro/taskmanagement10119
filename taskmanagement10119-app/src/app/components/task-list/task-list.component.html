<div class="task-list-container">
    <!--ヘッダー部分-->
    <header class="header">
        <div class="header-left">
            <button class="back-btn" (click)="goBack()">← 戻る</button>
            <h1>📋 タスク一覧</h1>
        </div>
        <div class="header-right">
            <!-- 表示モード切り替えボタン -->
            <div class="view-mode-selector">
                <button 
                    class="view-mode-btn" 
                    [class.active]="viewMode === 'table'"
                    (click)="switchViewMode('table')"
                    title="リスト表示">
                    📊
                </button>
                <button 
                    class="view-mode-btn" 
                    [class.active]="viewMode === 'card'"
                    (click)="switchViewMode('card')"
                    title="カード表示">
                    📋
                </button>
            </div>
            <button class="create-btn" (click)="openCreateTaskModal()">+ タスク作成</button>
        </div>
    </header>

    <!--メイン表示-->
    <main class="main-content">
        <!--フィルター・ソートセクション-->
        <div *ngIf="!isLoading" class="filter-sort-section">
            <!-- ステータスフィルター -->
            <div class="filter-group" *ngIf="viewMode === 'table'">
                <label class="filter-label">ステータス:</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="statusFilters.has('not_started')"
                            (change)="onStatusFilterChange('not_started', $any($event.target).checked)">
                        <span>未着手</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="statusFilters.has('in_progress')"
                            (change)="onStatusFilterChange('in_progress', $any($event.target).checked)">
                        <span>進行中</span>
                    </label>
                </div>
            </div>
            
            <!-- 期限切れフィルター（独立） -->
            <div class="filter-group" *ngIf="viewMode === 'table'">
                <label class="filter-label">期限切れ:</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="overdueFilter"
                            (change)="onOverdueFilterChange($any($event.target).checked)">
                        <span>期限切れを含める</span>
                    </label>
                </div>
            </div>
            
            <!-- 重要度フィルター -->
            <div class="filter-group priority-filter-group">
                <label class="filter-label">重要度:</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="priorityFilters.has('important')"
                            (change)="onPriorityFilterChange('important', $any($event.target).checked)">
                        <span>重要</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="priorityFilters.has('normal')"
                            (change)="onPriorityFilterChange('normal', $any($event.target).checked)">
                        <span>普通</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="priorityFilters.has('low')"
                            (change)="onPriorityFilterChange('low', $any($event.target).checked)">
                        <span>低め</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="priorityFilters.has('none')"
                            (change)="onPriorityFilterChange('none', $any($event.target).checked)">
                        <span>なし</span>
                    </label>
                </div>
            </div>
            
            <!-- タスクタイプフィルター -->
            <div class="filter-group">
                <label class="filter-label">タスクタイプ:</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="taskTypeFilters.has('normal')"
                            (change)="onTaskTypeFilterChange('normal', $any($event.target).checked)">
                        <span>通常</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="taskTypeFilters.has('meeting')"
                            (change)="onTaskTypeFilterChange('meeting', $any($event.target).checked)">
                        <span>会議</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="taskTypeFilters.has('regular')"
                            (change)="onTaskTypeFilterChange('regular', $any($event.target).checked)">
                        <span>定期</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="taskTypeFilters.has('project')"
                            (change)="onTaskTypeFilterChange('project', $any($event.target).checked)">
                        <span>プロジェクト</span>
                    </label>
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            [checked]="taskTypeFilters.has('other')"
                            (change)="onTaskTypeFilterChange('other', $any($event.target).checked)">
                        <span>その他</span>
                    </label>
                </div>
            </div>
            
            <div class="sort-group">
                <label>ソート:</label>
                <select [value]="sortBy" (change)="onSortChange($any($event.target).value)">
                    <option value="endDate">期限順</option>
                    <option value="startDate">開始日順</option>
                    <option value="priority">重要度順</option>
                    <option value="title">タイトル順</option>
                </select>
                <button class="sort-order-btn" (click)="toggleSortOrder()">
                    {{ sortOrder === 'asc' ? '昇順 ↑ ' : '降順 ↓ ' }}
                </button>
            </div>
        </div>

        <!--ローディング表示-->
        <div *ngIf="isLoading" class="loading">
            <div class="spinner"></div>
            読み込み中...
        </div>

        <!--タスクがない場合（タスクが全くない場合、または完了済みタスクのみの場合）-->
        <div *ngIf="!isLoading && (tasks.length === 0 || !hasIncompleteTasks)" class="no-tasks">
            <div class="empty-state">
                <h3>タスクがありません</h3>
                <p>新しいタスクを作成してみましょう！</p>
                <button class="create-btn" (click)="openCreateTaskModal()">+ 最初のタスクを作成</button>
            </div>
        </div>

        <!--フィルターで全て除外された場合のメッセージ（カード表示）-->
        <div *ngIf="viewMode === 'card' && !isLoading && hasIncompleteTasks && filteredTasks.length === 0" class="no-tasks">
            <div class="empty-state">
                <h3>条件に一致するタスクがありません</h3>
                <p>フィルター条件を変更してみましょう。</p>
            </div>
        </div>

        <!--カード表示（デフォルト）-->
        <div *ngIf="viewMode === 'card' && !isLoading && hasIncompleteTasks && filteredTasks.length > 0" class="task-groups-container">
            <ng-container *ngFor="let groupKey of ['not_started', 'in_progress', 'overdue']">
            <div class="task-group">
                
                <!--グループヘッダー-->
                <div class="group-header" [style.border-left-color]="getGroupColor(groupKey)">
                    <h3>{{ getGroupTitle(groupKey) }}</h3>
                    <span class="task-count">{{ taskGroups[groupKey].length }}件</span>
                </div>

                <!--グループ内のタスク（ある場合）-->
                <div class="group-tasks" *ngIf="taskGroups[groupKey].length > 0">
                    <div *ngFor="let task of taskGroups[groupKey]" 
                         class="task-card" 
                         [class.overdue-start-date]="isOverdueStartDate(task)"
                         [class.overdue-end-date]="isOverdueEndDate(task)"
                         [title]="isOverdueStartDate(task) ? '開始日が過ぎています' : (isOverdueEndDate(task) ? '期限が過ぎています' : '')"
                         (click)="viewTaskDetail(task.id)">

                        <!--タスクタイトル-->
                        <h4 class="task-title">{{ task.title }}</h4>

                        <!--チーム名（ある場合のみ）-->
                        <p *ngIf="task.teamName" class="team-name">チーム: {{ task.teamName }}</p>

                        <!--説明文（ある場合のみ）-->
                        <p *ngIf="task.description" class="task-description">{{ task.description }}</p>

                        <!--タスクメタ情報-->
                        <div class="task-meta">
                            <span class="due-date">期限: {{ formatDate(task.endDate) }}</span>
                        </div>

                        <!--プロジェクト情報（ある場合のみ）-->
                        <div *ngIf="task.projectId" class="project-info-flex">
                            <span class="project-info">
                              📁 {{ task.projectName }}
                            </span>
                        </div>

                        
                    </div>
                </div>

                <!--グループ内にタスクがない場合-->
                <div class="group-empty" *ngIf="taskGroups[groupKey].length === 0">
                    <p class="empty-message">タスクがありません</p>
                </div>
            </div>
            </ng-container>
        </div>

        <!--フィルターで全て除外された場合のメッセージ（テーブル表示）-->
        <div *ngIf="viewMode === 'table' && !isLoading && hasIncompleteTasks && filteredTasks.length === 0" class="no-tasks">
            <div class="empty-state">
                <h3>条件に一致するタスクがありません</h3>
                <p>フィルター条件を変更してみましょう。</p>
            </div>
        </div>

        <!--テーブル表示（オプション）-->
        <div *ngIf="viewMode === 'table' && !isLoading && filteredTasks.length > 0" class="table-container">
            <div class="table-actions" *ngIf="filteredTasks.length > 0">
                <button class="select-all-btn" (click)="toggleAllTasks()">
                    {{ selectedTasks.size === filteredTasks.length ? '全解除' : '全選択' }}
                </button>
                <button 
                    *ngIf="selectedTasks.size > 0" 
                    class="delete-selected-btn" 
                    (click)="deleteSelectedTasks()">
                    選択した{{ selectedTasks.size }}件を削除
                </button>
            </div>
            <table class="task-table">
                <thead>
                    <tr>
                        <th class="check-column"></th>
                        <th>タイトル</th>
                        <th>期限</th>
                        <th>重要度</th>
                        <th>担当</th>
                        <th>ステータス</th>
                        <th>作業時間</th>
                    </tr>
                </thead>
                <tbody>
                    <tr 
                        *ngFor="let task of filteredTasks" 
                        class="task-row"
                        [class.overdue-start-date]="isOverdueStartDate(task)"
                        [class.overdue-end-date]="isOverdueEndDate(task)">
                        <td class="check-column">
                            <input 
                                type="checkbox" 
                                [checked]="selectedTasks.has(task.id)"
                                (change)="toggleTaskSelection(task.id)"
                                (click)="$event.stopPropagation()">
                        </td>
                        <td class="title-cell" (click)="viewTaskDetail(task.id)">
                            <strong>{{ task.title }}</strong>
                            <span *ngIf="task.teamName" class="team-name">（チーム: {{ task.teamName }}）</span>
                        </td>
                        <td>{{ formatDate(task.endDate) }}</td>
                        <td>
                            <span class="priority-badge" [ngClass]="'priority-' + task.priority">
                                {{ getPriorityLabel(task.priority) }}
                            </span>
                        </td>
                        <td>{{ getAssigneeName(task) }}</td>
                        <td>
                            <span class="status-badge" [ngClass]="'status-' + task.status">
                                {{ getStatusLabel(task.status) }}
                            </span>
                        </td>
                        <td>{{ formatWorkTime(task.totalWorkTime) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
