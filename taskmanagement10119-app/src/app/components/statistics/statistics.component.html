<div class="statistics-container">
  <header class="header">
    <button class="back-btn" (click)="goBack()">â† æˆ»ã‚‹</button>
    <h1>ğŸ“ˆ çµ±è¨ˆ</h1>
  </header>

  <main class="main-content">
    <!-- æ™‚é–“ç¯„å›²ã®åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="time-range-selector">
      <button 
        class="range-btn" 
        [class.active]="timeRange === 'thisWeek'"
        (click)="switchTimeRange('thisWeek')">
        ä»Šé€±
      </button>
      <button 
        class="range-btn" 
        [class.active]="timeRange === 'lastWeek'"
        (click)="switchTimeRange('lastWeek')">
        å…ˆé€±
      </button>
      <button 
        class="range-btn" 
        [class.active]="timeRange === 'thisMonth'"
        (click)="switchTimeRange('thisMonth')">
        ä»Šæœˆ
      </button>
      <button 
        class="range-btn" 
        [class.active]="timeRange === 'lastMonth'"
        (click)="switchTimeRange('lastMonth')">
        å…ˆæœˆ
      </button>
      <button 
        class="range-btn" 
        [class.active]="timeRange === 'last3Months'"
        (click)="switchTimeRange('last3Months')">
        éå»3ã‹æœˆ
      </button>
      <button 
        class="range-btn" 
        [class.active]="timeRange === 'custom'"
        (click)="switchTimeRange('custom')">
        ã‚«ã‚¹ã‚¿ãƒ 
      </button>
    </div>

    <!-- è¡¨ç¤ºæœŸé–“ã®æ˜ç¤º -->
    <div class="date-range-display" *ngIf="!isLoading">
      <span class="date-range-label">è¡¨ç¤ºæœŸé–“: {{ getDateRangeLabel() }}</span>
    </div>

    <!-- åˆ¤å®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="filter-pattern-selector">
      <label class="pattern-label">
        åˆ¤å®šåŸºæº–ï¼š
      </label>
      <button 
        class="pattern-btn" 
        [class.active]="filterPattern === 'endDate'"
        (click)="switchFilterPattern('endDate')">
        æœŸé™æ—¥åŸºæº–
      </button>
      <button 
        class="pattern-btn" 
        [class.active]="filterPattern === 'startDate'"
        (click)="switchFilterPattern('startDate')">
        é–‹å§‹æ—¥åŸºæº–
      </button>
      <button 
        class="pattern-btn" 
        [class.active]="filterPattern === 'overlap'"
        (click)="switchFilterPattern('overlap')">
        é‡è¤‡ãƒ™ãƒ¼ã‚¹
      </button>
    </div>
    <span class="filter-pattern-selector-item">
      (åˆ¤å®šåŸºæº–ã«ã¤ã„ã¦ï¼šæœŸé™æ—¥åŸºæº–ã¯è¡¨ç¤ºæœŸé–“ã«æœŸé™æ—¥ã®ã¿ãŒå«ã¾ã‚Œã‚‹ã€é–‹å§‹æ—¥åŸºæº–ã¯è¡¨ç¤ºæœŸé–“ã«é–‹å§‹æ—¥ã®ã¿ãŒå«ã¾ã‚Œã‚‹ã€é‡è¤‡ãƒ™ãƒ¼ã‚¹ã¯ã‚¿ã‚¹ã‚¯ã®æœŸé–“ãŒè¡¨ç¤ºæœŸé–“ã¨å°‘ã—ã§ã‚‚é‡ãªã£ã¦ã„ã‚‹æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚)
    </span>

    <div *ngIf="isLoading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div *ngIf="!isLoading" class="statistics-content">
      
      <!-- å…¨ä½“çµ±è¨ˆ -->
      <section class="stats-section">
        <h2>{{ getTimeRangeLabel() }}ã®çµ±è¨ˆ</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
            <div class="stat-value">{{ statistics.totalTasks }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å®Œäº†ã‚¿ã‚¹ã‚¯æ•°</div>
            <div class="stat-value completed">{{ statistics.completedTasks }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å®Œäº†ç‡</div>
            <div class="stat-value">
              <span class="percentage">{{ statistics.completionRate }}%</span>
              <div class="progress-bar">
                <div 
                  class="progress-fill" 
                  [style.width.%]="statistics.completionRate">
                </div>
              </div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç·ä½œæ¥­æ™‚é–“</div>
            <div class="stat-value">{{ formatTime(statistics.totalWorkTime) }}</div>
          </div>
          <div class="stat-card delayed">
            <div class="stat-label">é…å»¶ã‚¿ã‚¹ã‚¯æ•°</div>
            <div class="stat-value">{{ statistics.delayedTasks }}</div>
          </div>
        </div>
      </section>

      <!-- ä½œæ¥­æ™‚é–“ã®æ¨ç§»ã‚°ãƒ©ãƒ• -->
      <section class="stats-section">
        <h2>ä½œæ¥­æ™‚é–“ã®æ¨ç§»</h2>
        <div class="chart-container">
          <canvas #workTimeChart></canvas>
        </div>
      </section>

      <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥çµ±è¨ˆ -->
      <section class="stats-section" *ngIf="projectStatistics.length > 0">
        <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥çµ±è¨ˆ</h2>
        <div class="project-stats">
          <div *ngFor="let projectStat of projectStatistics" class="project-stat-card">
            <h3 class="project-name">{{ projectStat.project.name }}</h3>
            <div class="project-stats-grid">
              <div class="project-stat-item">
                <span class="project-stat-label">ã‚¿ã‚¹ã‚¯æ•°</span>
                <span class="project-stat-value">{{ projectStat.totalTasks }}</span>
              </div>
              <div class="project-stat-item">
                <span class="project-stat-label">å®Œäº†æ•°</span>
                <span class="project-stat-value">{{ projectStat.completedTasks }}</span>
              </div>
              <div class="project-stat-item">
                <span class="project-stat-label">å®Œäº†ç‡</span>
                <span class="project-stat-value">
                  {{ projectStat.completionRate }}%
                </span>
                <div class="project-progress-bar">
                  <div 
                    class="project-progress-fill" 
                    [style.width.%]="projectStat.completionRate">
                  </div>
                </div>
              </div>
              <div class="project-stat-item">
                <span class="project-stat-label">ä½œæ¥­æ™‚é–“</span>
                <span class="project-stat-value">
                  {{ formatTime(projectStat.totalWorkTime) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- é…å»¶ã‚¿ã‚¹ã‚¯è©³ç´° -->
      <section class="stats-section" *ngIf="statistics.delayedTasks > 0">
        <h2>âš ï¸ é…å»¶ã‚¿ã‚¹ã‚¯</h2>
        <div class="delayed-info">
          <p>ç¾åœ¨ã€{{ statistics.delayedTasks }}ä»¶ã®ã‚¿ã‚¹ã‚¯ãŒæœŸé™ã‚’éãã¦ã„ã¾ã™ã€‚</p>
          <button 
            class="details-btn" 
            (click)="toggleDelayedTasksDetails()">
            {{ showDelayedTasksDetails ? 'é–‰ã˜ã‚‹' : 'è©³ç´°' }}
          </button>
        </div>
        
        <!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
        <div class="delayed-tasks-list" *ngIf="showDelayedTasksDetails">
          <div 
            *ngFor="let task of delayedTasksList" 
            class="delayed-task-item"
            (click)="viewTaskDetail(task.id)">
            <div class="task-title-row">
              <span class="task-title">{{ task.title }}</span>
              <span class="task-status" [ngClass]="'status-' + task.status">
                {{ getStatusLabel(task.status) }}
              </span>
            </div>
            <div class="task-meta-row">
              <span class="task-due-date">æœŸé™: {{ formatDate(task.endDate) }}</span>
              <span class="task-project" *ngIf="task.projectName">
                ğŸ“ {{ task.projectName }}
              </span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ã‚«ã‚¹ã‚¿ãƒ æœŸé–“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" *ngIf="showCustomRangeModal" (click)="closeCustomRangeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã‚’é¸æŠ</h2>
        <button class="close-btn" (click)="closeCustomRangeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="customStartDate">é–‹å§‹æ—¥ *</label>
          <input
            type="date"
            id="customStartDate"
            class="form-control"
            [(ngModel)]="customStartDate"
            required>
        </div>
        <div class="form-group">
          <label for="customEndDate">çµ‚äº†æ—¥ *</label>
          <input
            type="date"
            id="customEndDate"
            class="form-control"
            [(ngModel)]="customEndDate"
            required>
        </div>
        <div class="form-group">
          <p class="help-text">ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã¯æœ€é•·92æ—¥é–“ã¾ã§è¨­å®šã§ãã¾ã™ã€‚</p>
        </div>
        <div class="error-message" *ngIf="customRangeError">
          {{ customRangeError }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCustomRangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" (click)="applyCustomRange()">é©ç”¨</button>
      </div>
    </div>
  </div>
</div>

