<div class="comments-container">
  <header class="header">
    <button class="back-btn" (click)="goBack()">â† æˆ»ã‚‹</button>
    <h1>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h1>
  </header>

  <main class="main-content">
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="filters-section">
      <!-- æ¤œç´¢çª“ -->
      <div class="search-box">
        <input 
          type="text" 
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢..."
          [(ngModel)]="searchKeyword"
          (ngModelChange)="onSearchChange()"
          class="search-input">
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <div class="filters">
        <div class="filter-group autocomplete-group">
          <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</label>
          <div class="autocomplete-wrapper">
            <input 
              type="text" 
              placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›..."
              [(ngModel)]="projectNameInput"
              (ngModelChange)="onProjectNameChange($event)"
              (focus)="onProjectNameInput()"
              (blur)="hideProjectSuggestions()"
              class="autocomplete-input">
            <button *ngIf="projectNameInput" 
                    class="clear-btn" 
                    (click)="clearProjectFilter(); $event.stopPropagation()"
                    type="button">Ã—</button>
            <div class="autocomplete-dropdown" *ngIf="showProjectSuggestions && filteredProjectSuggestions.length > 0">
              <div *ngFor="let project of filteredProjectSuggestions" 
                   class="autocomplete-item"
                   (mousedown)="selectProject(project); $event.preventDefault()">
                {{ project.name }}
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group autocomplete-group">
          <label>ã‚¿ã‚¹ã‚¯:</label>
          <div class="autocomplete-wrapper">
            <input 
              type="text" 
              placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›..."
              [(ngModel)]="taskNameInput"
              (ngModelChange)="onTaskNameChange($event)"
              (focus)="onTaskNameInput()"
              (blur)="hideTaskSuggestions()"
              class="autocomplete-input">
            <button *ngIf="taskNameInput" 
                    class="clear-btn" 
                    (click)="clearTaskFilter(); $event.stopPropagation()"
                    type="button">Ã—</button>
            <div class="autocomplete-dropdown" *ngIf="showTaskSuggestions && filteredTaskSuggestions.length > 0">
              <div *ngFor="let task of filteredTaskSuggestions" 
                   class="autocomplete-item"
                   (mousedown)="selectTask(task); $event.preventDefault()">
                {{ task.title }}
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label>æœªèª­/æ—¢èª­:</label>
          <select [(ngModel)]="selectedReadStatus" (change)="onFilterChange()">
            <option value="all">ã™ã¹ã¦</option>
            <option value="read">æ—¢èª­</option>
            <option value="unread">æœªèª­</option>
          </select>
        </div>

        <div class="filter-group">
          <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
          <select [(ngModel)]="selectedTaskStatus" (change)="onFilterChange()">
            <option value="all">ã™ã¹ã¦</option>
            <option value="not_started">æœªç€æ‰‹</option>
            <option value="in_progress">é€²è¡Œä¸­</option>
            <option value="completed">å®Œäº†æ¸ˆã¿</option>
          </select>
        </div>

        <div class="filter-group">
          <label>å„ªå…ˆåº¦:</label>
          <select [(ngModel)]="selectedPriority" (change)="onFilterChange()">
            <option value="all">ã™ã¹ã¦</option>
            <option value="important">é‡è¦</option>
            <option value="normal">æ™®é€š</option>
            <option value="low">ä½ã‚</option>
            <option value="none">ãªã—</option>
          </select>
        </div>

        <div class="filter-group">
          <label>&#64;ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³:</label>
          <select [(ngModel)]="hasMention" (change)="onFilterChange()">
            <option value="all">ã™ã¹ã¦</option>
            <option value="mentioned">è‡ªåˆ†ãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯</option>
            <option value="no">è‡ªåˆ†ãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚Œã¦ãªã„ã‚¿ã‚¹ã‚¯</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯å˜ä½ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
    <div class="tasks-with-comments-list-container">
      <div *ngIf="isLoading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div *ngIf="!isLoading && filteredTasksWithComments.length === 0" class="no-comments">
        ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
      </div>

      <div *ngIf="!isLoading" class="tasks-with-comments-list">
        <div *ngFor="let taskItem of filteredTasksWithComments" 
             class="task-comment-item" 
             (click)="viewItem(taskItem)"
             role="button"
             tabindex="0"
             (keydown.enter)="viewItem(taskItem)"
             (keydown.space)="viewItem(taskItem); $event.preventDefault()">
          
          <!-- ã‚¿ã‚¹ã‚¯/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ãƒ˜ãƒƒãƒ€ãƒ¼ -->
          <div class="task-header">
            <h3 class="task-title">
              <span *ngIf="taskItem.isProject">ğŸ“ </span>{{ taskItem.itemTitle }}
            </h3>
            <div class="task-badges">
              <span *ngIf="!taskItem.isProject" class="task-status-badge" [ngClass]="'status-' + taskItem.taskStatus">
                {{ getStatusLabel(taskItem.taskStatus) }}
              </span>
              <span *ngIf="!taskItem.isProject" class="task-priority-badge" [ngClass]="'priority-' + taskItem.taskPriority">
                {{ getPriorityLabel(taskItem.taskPriority) }}
              </span>
              <span *ngIf="!taskItem.isProject && taskItem.projectName" class="project-badge">ğŸ“ {{ taskItem.projectName }}</span>
            </div>
          </div>

          <!-- æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆã®æŠœç²‹ -->
          <div class="latest-comment-preview" *ngIf="taskItem.latestComment">
            <div class="comment-preview-content" [innerHTML]="searchKeyword.trim() ? highlightKeyword(taskItem.latestCommentPreview, searchKeyword) : taskItem.latestCommentPreview"></div>
            <div class="comment-preview-meta">
              <span class="comment-author">{{ taskItem.latestComment.userName }}</span>
              <span class="comment-date">{{ formatDateTime(taskItem.latestComment.createdAt) }}</span>
            </div>
          </div>

          <!-- ã‚³ãƒ¡ãƒ³ãƒˆçµ±è¨ˆæƒ…å ± -->
          <div class="comment-stats">
            <span class="total-comments">ã‚³ãƒ¡ãƒ³ãƒˆ: {{ taskItem.totalCommentCount }}ä»¶</span>
            <span *ngIf="taskItem.unreadCount > 0" class="unread-badge">
              {{ taskItem.unreadCount }}ä»¶ã®æœªèª­
            </span>
            <span *ngIf="searchKeyword.trim() && taskItem.matchingCommentCount" class="matching-count">
              ã€Œ{{ searchKeyword }}ã€ã«è©²å½“: {{ taskItem.matchingCommentCount }}ä»¶
            </span>
          </div>

          <!-- @ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
          <div class="mention-indicator" *ngIf="taskItem.hasMentionForCurrentUser">
            <span class="mention-badge">&#64;è‡ªåˆ†ãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚Š</span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
