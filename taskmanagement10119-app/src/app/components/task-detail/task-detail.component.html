<div class="task-detail-container">
  <div *ngIf="isLoading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  
  <div *ngIf="!isLoading && task" class="task-detail-card">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <button class="back-btn" (click)="goBack()">â† æˆ»ã‚‹</button>
      <div class="header-actions">
        <button *ngIf="!isEditing && canEdit" class="edit-btn" (click)="toggleEdit()">ç·¨é›†</button>
        <button *ngIf="!isEditing" class="duplicate-btn" (click)="onDuplicate()">è¤‡è£½</button>
        <button *ngIf="!isEditing && canDelete" class="delete-btn" (click)="onDelete()">å‰Šé™¤</button>
      </div>
    </div>

    <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
    <div *ngIf="!isEditing" class="view-mode">
      <h1>{{ task.title }}</h1>
      <div class="task-info">
        <div class="info-item" *ngIf="task.projectName || projectName">
          <span class="label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span>
          <span>{{ projectName || task.projectName }}</span>
        </div>
        <div class="info-item" *ngIf="task.teamName || teamName">
          <span class="label">ãƒãƒ¼ãƒ :</span>
          <span>{{ teamName || task.teamName }}</span>
        </div>
        <div class="info-item" *ngIf="task.assigneeName">
          <span class="label">æ‹…å½“è€…:</span>
          <span>{{ task.assigneeName }}</span>
        </div>
        <div class="info-item">
          <span class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
          <span class="status-badge status-{{ task.status }}">{{ getStatusLabel(task.status) }}</span>
        </div>
        <div class="info-item">
          <span class="label">é‡è¦åº¦:</span>
          <span class="priority-badge priority-{{ task.priority }}">{{ getPriorityLabel(task.priority) }}</span>
        </div>
        <div class="info-item">
          <span class="label">ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—:</span>
          <span>{{ getTaskTypeLabel(task.taskType || 'normal') }}</span>
        </div>
        <div class="info-item">
          <span class="label">é–‹å§‹æ—¥æ™‚:</span>
          <span>{{ formatDateWithTime(task.startDate) }}</span>
        </div>
        <div class="info-item">
          <span class="label">æœŸé™æ—¥æ™‚:</span>
          <span>{{ formatDateWithTime(task.endDate) }}</span>
        </div>
        <div class="info-item" *ngIf="task.description">
          <span class="label">èª¬æ˜:</span>
          <p>{{ task.description }}</p>
        </div>
        <div class="info-item" *ngIf="task.memo">
          <span class="label">ãƒ¡ãƒ¢:</span>
          <p>{{ task.memo }}</p>
        </div>
        <div class="info-item" *ngIf="task.reminders && task.reminders.length > 0">
          <span class="label">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼:</span>
          <div class="reminders-list">
            <div *ngFor="let reminder of task.reminders" class="reminder-item">
              <span *ngIf="reminder.type === 'before_start'" class="reminder-info">
                é–‹å§‹å‰: {{ formatReminderTime(reminder) }}å‰
              </span>
              <span *ngIf="reminder.type === 'before_end'" class="reminder-info">
                æœŸé™å‰: {{ formatReminderTime(reminder) }}å‰
              </span>
              <span *ngIf="reminder.scheduledAt" class="reminder-info">
                ã‚«ã‚¹ã‚¿ãƒ : {{ formatDateTime(reminder.scheduledAt) }}
              </span>
              <span *ngIf="reminder.sent" class="reminder-sent">âœ“ é€ä¿¡æ¸ˆã¿</span>
              <span *ngIf="reminder.sentAt" class="reminder-sent-at">
                ({{ formatDateTime(reminder.sentAt) }})
              </span>
            </div>
          </div>
        </div>
        <div class="info-item">
          <span class="label">ä½œæ¥­æ™‚é–“:</span>
          <span>{{ formatWorkTime(task.totalWorkTime) }}</span>
          <button class="details-btn" (click)="toggleWorkTimeDetails()">
            {{ showWorkTimeDetails ? 'è©³ç´°ã‚’é–‰ã˜ã‚‹' : 'è©³ç´°' }}
          </button>
        </div>

        <!-- ä½œæ¥­æ™‚é–“è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div *ngIf="showWorkTimeDetails" class="work-time-details">
          <h4>ä½œæ¥­æ™‚é–“è©³ç´°</h4>
          <table class="work-sessions-table" *ngIf="task.workSessions && task.workSessions.length > 0">
            <thead>
              <tr>
                <th>é–‹å§‹æ™‚é–“</th>
                <th>çµ‚äº†æ™‚é–“</th>
                <th>ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
                <th>å®Ÿåƒæ™‚é–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let session of task.workSessions">
                <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
                <tr *ngIf="editingSessionId === session.id" [formGroup]="editSessionForm" class="editing">
                  <td>
                    <input type="datetime-local" formControlName="startTime">
                  </td>
                  <td>
                    <input type="datetime-local" formControlName="endTime">
                  </td>
                  <td>
                    <input type="number" formControlName="breakDuration" min="0">
                  </td>
                  <td>{{ formatWorkTime(calculateActualDuration()) }}</td>
                  <td>
                    <button class="save-btn" (click)="saveSessionEdit()">ä¿å­˜</button>
                    <button class="cancel-btn" (click)="cancelSessionEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  </td>
                </tr>
                <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
                <tr *ngIf="editingSessionId !== session.id">
                  <td>{{ formatDateTime(session.startTime) }}</td>
                  <td>{{ session.endTime ? formatDateTime(session.endTime) : '-' }}</td>
                  <td>{{ session.breakDuration }}åˆ†</td>
                  <td>{{ formatWorkTime(session.actualDuration) }}</td>
                  <td>
                    <button class="edit-session-btn" (click)="startEditSession(session)">ä¿®æ­£</button>
                    <button class="view-log-btn" (click)="viewSessionChangeLog(session.id)" *ngIf="session.changeLogs && session.changeLogs.length > 0">å¤‰æ›´ãƒ­ã‚°</button>
                  </td>
                </tr>
              </ng-container>
              <!-- æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ è¡Œ -->
              <tr *ngIf="addingNewSession" class="adding" [formGroup]="newSessionForm">
                <td>
                  <input type="datetime-local" formControlName="startTime">
                </td>
                <td>
                  <input type="datetime-local" formControlName="endTime">
                </td>
                <td>
                  <input type="number" formControlName="breakDuration" min="0">
                </td>
                <td>{{ formatWorkTime(calculateNewSessionDuration()) }}</td>
                <td>
                  <button class="save-btn" (click)="saveNewSession()">ä¿å­˜</button>
                  <button class="cancel-btn" (click)="cancelNewSession()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </td>
              </tr>
              <!-- è¿½åŠ ãƒœã‚¿ãƒ³è¡Œ -->
              <tr class="add-session-row">
                <td colspan="5">
                  <button class="add-session-btn" (click)="startAddNewSession()" *ngIf="!addingNewSession">ä½œæ¥­æ™‚é–“ã‚’è¿½åŠ </button>
                </td>
              </tr>
              <tr class="total-row">
                <td colspan="3"><strong>åˆè¨ˆä½œæ¥­æ™‚é–“</strong></td>
                <td><strong>{{ formatWorkTime(getTotalWorkTime()) }}</strong></td>
                <td></td>
              </tr>
            </tbody>
          </table>
          
          <!-- ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã®è¡¨ç¤º -->
          <div *ngIf="!task.workSessions || task.workSessions.length === 0" class="no-sessions">
            <p>ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <button class="add-session-btn" (click)="startAddNewSession()" *ngIf="!addingNewSession">ä½œæ¥­æ™‚é–“ã‚’è¿½åŠ </button>
            <div *ngIf="addingNewSession" class="add-session-form">
              <table class="work-sessions-table">
                <thead>
                  <tr>
                    <th>é–‹å§‹æ™‚é–“</th>
                    <th>çµ‚äº†æ™‚é–“</th>
                    <th>ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
                    <th>å®Ÿåƒæ™‚é–“</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="adding" [formGroup]="newSessionForm">
                    <td>
                      <input type="datetime-local" formControlName="startTime">
                    </td>
                    <td>
                      <input type="datetime-local" formControlName="endTime">
                    </td>
                    <td>
                      <input type="number" formControlName="breakDuration" min="0">
                    </td>
                    <td>{{ formatWorkTime(calculateNewSessionDuration()) }}</td>
                    <td>
                      <button class="save-btn" (click)="saveNewSession()">ä¿å­˜</button>
                      <button class="cancel-btn" (click)="cancelNewSession()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- å¤‰æ›´ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div *ngIf="selectedSessionId" class="change-log-modal" (click)="closeChangeLogModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <h4>å¤‰æ›´ãƒ­ã‚°</h4>
            <table class="change-log-table">
              <thead>
                <tr>
                  <th>å¤‰æ›´æ—¥æ™‚</th>
                  <th>å¤‰æ›´è€…</th>
                  <th>é …ç›®</th>
                  <th>å¤‰æ›´å‰</th>
                  <th>å¤‰æ›´å¾Œ</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let log of getSessionChangeLogs(selectedSessionId)">
                  <td>{{ formatDateTime(log.changedAt) }}</td>
                  <td>{{ log.changedByName }}</td>
                  <td>{{ getFieldLabel(log.field) }}</td>
                  <td>{{ formatChangeValue(log.field, log.oldValue) }}</td>
                  <td>{{ formatChangeValue(log.field, log.newValue) }}</td>
                </tr>
                <tr *ngIf="getSessionChangeLogs(selectedSessionId).length === 0">
                  <td colspan="5" class="no-logs">å¤‰æ›´ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</td>
                </tr>
              </tbody>
            </table>
            <button class="close-modal-btn" (click)="closeChangeLogModal()">é–‰ã˜ã‚‹</button>
          </div>
        </div>
      </div>

      <!-- ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãƒ»é€²æ—ç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆshowProgressãŒtrueã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="subtasks-section" *ngIf="task.showProgress">
        <h3>ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãƒ»é€²æ—ç‡</h3>
        <div class="progress-info">
          <span>é€²æ—: {{ getCompletedSubtasks() }} / {{ task.subtasks.length || 0 }}</span>
          <span class="progress-percentage">{{ getProgressPercentage() }}%</span>
          
          <!-- æ‰‹å‹•è¨ˆç®—ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸè¡¨ç¤ºã€æ‰‹å‹•ä¿®æ­£ä¸­ã§ãªã„å ´åˆã®ã¿ï¼‰ -->
          <div class="progress-manual-control" *ngIf="!showManualInput && !task.progressManual">
            <button class="manual-calc-btn" (click)="showManualProgressInput()">æ‰‹å‹•è¨ˆç®—</button>
          </div>
          
          <!-- æ‰‹å‹•ä¿®æ­£ä¸­ã®å ´åˆã®è¡¨ç¤º -->
          <div class="progress-manual-control" *ngIf="!showManualInput && task.progressManual">
            <span class="manual-progress-indicator">
              <span class="manual-label">æ‰‹å‹•ä¿®æ­£ä¸­</span>
              <button class="resume-auto-btn" (click)="resumeAutoProgress()">è‡ªå‹•è¨ˆç®—ã‚’å†é–‹</button>
            </span>
          </div>
          
          <!-- æ‰‹å‹•å…¥åŠ›æ¬„ï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œè¡¨ç¤ºï¼‰ -->
          <div class="progress-manual-control" *ngIf="showManualInput">
            <input 
              type="number" 
              min="0" 
              max="100" 
              [(ngModel)]="manualProgressValue"
              class="progress-input"
              placeholder="æ‰‹å‹•å…¥åŠ›">
            <span class="percent-symbol">%</span>
            <button class="confirm-btn" (click)="onManualProgressChange(manualProgressValue)">æ±ºå®š</button>
            <button class="cancel-manual-btn" (click)="cancelManualProgressInput()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
        
        <ul class="subtask-list">
          <li *ngFor="let subtask of task.subtasks; let i = index" class="subtask-item" [class.completed]="subtask.completed">
            <input 
              type="checkbox" 
              [checked]="subtask.completed"
              (change)="toggleSubtask(subtask.id, i)">
            <span class="subtask-title">{{ subtask.title }}</span>
            <button class="delete-subtask-btn" (click)="deleteSubtask(subtask.id)">å‰Šé™¤</button>
          </li>
        </ul>

        <!-- ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ  -->
        <div class="add-subtask" *ngIf="task.showProgress">
          <input 
            type="text" 
            [(ngModel)]="newSubtaskTitle"
            placeholder="ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ..."
            (keyup.enter)="addSubtask()">
          <button (click)="addSubtask()">è¿½åŠ </button>
        </div>
      </div>

      <div class="timer-section" *ngIf="!isFromArchive">
        <button class="timer-btn" (click)="startTimer()">â±ï¸ ä½œæ¥­æ™‚é–“è¨ˆæ¸¬é–‹å§‹</button>
      </div>

      <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="comments-section">
        <div class="comments-header">
          <h3>ã‚³ãƒ¡ãƒ³ãƒˆ
            <span class="comment-count">ï¼ˆ{{ task.comments?.length || 0 }}ä»¶</span>
            <span class="unread-comment-count" *ngIf="unreadCommentCount > 0"> / æœªèª­{{ unreadCommentCount }}ä»¶</span>
            <span class="comment-count">ï¼‰</span>
          </h3>
          <button class="toggle-comments-btn" (click)="toggleCommentsTab()">
            {{ showCommentsTab ? 'é–‰ã˜ã‚‹' : 'é–‹ã' }}
          </button>
        </div>

        <div *ngIf="showCommentsTab" class="comments-content">
          <!-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
          <div class="add-comment">
            <div class="comment-input-wrapper">
              <textarea 
                #commentTextarea
                [(ngModel)]="newCommentContent"
                (input)="onCommentInput($event)"
                (blur)="hideMentionSuggestions()"
                placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ...ï¼ˆ@ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼‰"
                rows="3"></textarea>
              <!-- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãƒªã‚¹ãƒˆ -->
              <div *ngIf="showMentionSuggestions && mentionSuggestions.length > 0" class="mention-suggestions">
                <div 
                  *ngFor="let user of mentionSuggestions" 
                  class="mention-suggestion-item"
                  (mousedown)="selectMention(user); $event.preventDefault()">
                  <span class="mention-name">{{ user.name }}</span>
                  <span class="mention-email">{{ user.email }}</span>
                </div>
              </div>
            </div>
            <button (click)="addComment()">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
          </div>

          <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
          <div class="comments-list" *ngIf="task.comments && task.comments.length > 0">
            <div *ngFor="let comment of sortedComments" 
                 class="comment-item" 
                 [class.unread-comment]="isCommentUnread(comment.id)">
              <div class="comment-header">
                <span class="comment-author">{{ comment.userName }}</span>
                <span class="comment-date">{{ formatDateTime(comment.createdAt) }}</span>
                <span class="unread-badge" *ngIf="isCommentUnread(comment.id)">æœªèª­</span>
              </div>
              <div class="comment-content">{{ comment.content }}</div>
            </div>
          </div>
          <div *ngIf="!task.comments || task.comments.length === 0" class="no-comments">
            ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>

      <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="files-section" *ngIf="!isFromArchive">
        <h3>ãƒ•ã‚¡ã‚¤ãƒ«</h3>
        
        <div class="file-upload">
          <input 
            type="file" 
            multiple 
            (change)="onFileSelected($event)"
            id="fileInput"
            style="display: none;">
          <label for="fileInput" class="file-input-label">
            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          </label>
          <button 
            (click)="uploadFiles()" 
            [disabled]="selectedFiles.length === 0 || isUploadingFiles"
            class="upload-btn">
            {{ isUploadingFiles ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰' }}
          </button>
          <div *ngIf="selectedFiles.length > 0" class="selected-files">
            é¸æŠæ¸ˆã¿: {{ selectedFiles.length }}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«
          </div>
        </div>

        <div class="files-list" *ngIf="task.files && task.files.length > 0">
          <div *ngFor="let file of task.files" class="file-item">
            <span class="file-name">{{ file.name }}</span>
            <div class="file-actions">
              <button class="download-btn" (click)="downloadFile(file.url, file.name)">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
              <button class="delete-file-btn" (click)="deleteFile(file.id)">å‰Šé™¤</button>
            </div>
          </div>
        </div>
        <div *ngIf="!task.files || task.files.length === 0" class="no-files">
          ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
        </div>
      </div>
      
      <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‹ã‚‰æ¥ãŸå ´åˆã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ -->
      <div class="files-section" *ngIf="isFromArchive">
        <h3>ãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <div class="files-list" *ngIf="task.files && task.files.length > 0">
          <div *ngFor="let file of task.files" class="file-item">
            <span class="file-name">{{ file.name }}</span>
            <div class="file-actions">
              <button class="download-btn" (click)="downloadFile(file.url, file.name)">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
          </div>
        </div>
        <div *ngIf="!task.files || task.files.length === 0" class="no-files">
          ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
        </div>
      </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
    <div *ngIf="isEditing" class="edit-mode">
      <form [formGroup]="editForm" (ngSubmit)="onSave()">
        <div class="form-group">
          <label for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" id="title" formControlName="title">
        </div>

        <div class="form-group">
          <label for="description">èª¬æ˜</label>
          <textarea id="description" formControlName="description" rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="memo">ãƒ¡ãƒ¢</label>
          <textarea id="memo" formControlName="memo" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="status" formControlName="status">
            <option value="not_started">æœªç€æ‰‹</option>
            <option value="in_progress">é€²è¡Œä¸­</option>
            <option value="completed">å®Œäº†</option>
          </select>
        </div>

        <div class="form-group">
          <label for="priority">é‡è¦åº¦</label>
          <select id="priority" formControlName="priority">
            <option value="important">é‡è¦</option>
            <option value="normal">æ™®é€š</option>
            <option value="low">ä½ã‚</option>
            <option value="none">ãªã—</option>
          </select>
        </div>

        <div class="form-group">
          <label for="taskType">ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—</label>
          <select id="taskType" formControlName="taskType">
            <option value="normal">é€šå¸¸</option>
            <option value="meeting">ä¼šè­°</option>
            <option value="regular">å®šæœŸ</option>
            <option value="project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
            <option value="other">ãã®ä»–</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startDate">é–‹å§‹æ—¥</label>
            <input type="date" id="startDate" formControlName="startDate">
          </div>

          <div class="form-group">
            <label for="startTime">é–‹å§‹æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
            <input type="time" id="startTime" formControlName="startTime">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="endDate">æœŸé™</label>
            <input type="date" id="endDate" formControlName="endDate">
          </div>

          <div class="form-group">
            <label for="endTime">çµ‚äº†æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
            <input type="time" id="endTime" formControlName="endTime">
          </div>
        </div>

        <div class="form-group">
          <label for="assigneeId">æ‹…å½“è€…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
          <select id="assigneeId" formControlName="assigneeId">
            <option value="">æ‹…å½“è€…ãªã—</option>
            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã®å ´åˆï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ -->
            <ng-container *ngIf="task.projectId && projectMembers.length > 0">
              <option *ngFor="let member of projectMembers" [value]="member.userId">
                {{ member.userName || member.userEmail }}
              </option>
            </ng-container>
            <!-- ãƒãƒ¼ãƒ ã‚¿ã‚¹ã‚¯ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªæ‰€å±ï¼‰ã®å ´åˆï¼šãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ -->
            <ng-container *ngIf="task.teamId && !task.projectId && teamMembers.length > 0">
             <option *ngFor="let member of teamMembers" [value]="member.userId">
              {{ member.userName || member.userEmail }}
             </option>
            </ng-container>
            <!--å€‹äººã‚¿ã‚¹ã‚¯ã®å ´åˆ-->
            <ng-container *ngIf="!task.teamId">
            <option *ngFor="let user of users" [value]="user.id">
              {{ user.displayName || user.email }}
            </option>
          </ng-container>
          </select>
        </div>

        <div class="form-group">
          <label for="projectId">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
          <select id="projectId" formControlName="projectId">
            <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã—</option>
            <option *ngFor="let project of projects" [value]="project.id">
              {{ project.name }}
            </option>
          </select>
        </div>

        <!-- ç¹°ã‚Šè¿”ã—è¨­å®šï¼ˆè¦ªã‚¿ã‚¹ã‚¯ã®å ´åˆï¼‰ -->
        <div class="form-group" *ngIf="!isChildTask">
          <label for="recurrence">ç¹°ã‚Šè¿”ã—</label>
          <select id="recurrence" formControlName="recurrence">
            <option [value]="'none'">ç¹°ã‚Šè¿”ã•ãªã„</option>
            <option [value]="'daily'">æ¯æ—¥</option>
            <option [value]="'weekly'">æ¯é€±</option>
            <option [value]="'biweekly'">éš”é€±</option>
            <option [value]="'monthly'">æ¯æœˆ</option>
            <option [value]="'yearly'">æ¯å¹´</option>
          </select>
        </div>

        <div class="form-group" *ngIf="!isChildTask && editForm.get('recurrence')?.value !== 'none'">
          <label for="recurrenceEndDate">ç¹°ã‚Šè¿”ã—çµ‚äº†æ—¥ï¼ˆä»»æ„ï¼‰</label>
          <input type="date" id="recurrenceEndDate" formControlName="recurrenceEndDate">
        </div>

        <!-- å­ã‚¿ã‚¹ã‚¯ã®å ´åˆã€ç¹°ã‚Šè¿”ã—è¨­å®šã‚’è¡¨ç¤ºã®ã¿ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¦ªã‚¿ã‚¹ã‚¯ã«é·ç§»ï¼‰ -->
        <div class="form-group" *ngIf="isChildTask">
          <label>ç¹°ã‚Šè¿”ã—</label>
          <div class="readonly-field clickable" (click)="navigateToParentTask($event)" title="è¦ªã‚¿ã‚¹ã‚¯ã§ç¹°ã‚Šè¿”ã—è¨­å®šã‚’å¤‰æ›´">
            <span *ngIf="task.recurrence && task.recurrence !== 'none'">
              {{ getRecurrenceLabel(task.recurrence) }}
              <span *ngIf="task.recurrenceEndDate">
                ï¼ˆçµ‚äº†æ—¥: {{ formatDate(task.recurrenceEndDate) }}ï¼‰
              </span>
            </span>
            <span *ngIf="!task.recurrence || task.recurrence === 'none'">ç¹°ã‚Šè¿”ã•ãªã„</span>
            <span class="link-hint">â†’ è¦ªã‚¿ã‚¹ã‚¯ã§å¤‰æ›´</span>
          </div>
          <p class="help-text">ç¹°ã‚Šè¿”ã—è¨­å®šã¯è¦ªã‚¿ã‚¹ã‚¯ã§å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚ã‚¯ãƒªãƒƒã‚¯ã§è¦ªã‚¿ã‚¹ã‚¯ã®è©³ç´°ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚</p>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" formControlName="showProgress"> é€²æ—ç‡ã‚’è¡¨ç¤ºã™ã‚‹
          </label>
          <small class="form-hint">â€» é€²æ—ç‡ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã®ã¿ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãŒåˆ©ç”¨å¯èƒ½ã§ã™</small>
        </div>

        <!-- ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š -->
        <div class="form-group">
          <h3>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š</h3>
        </div>

        <!-- é–‹å§‹å‰ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
        <div class="form-group">
          <label>
            <input type="checkbox" formControlName="enableStartReminder"> é–‹å§‹å‰ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®š
          </label>
        </div>

        <div class="form-group" *ngIf="editForm.get('enableStartReminder')?.value">
          <label for="startReminderType">é–‹å§‹å‰ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</label>
          <select id="startReminderType" formControlName="startReminderType">
            <option value="1day">1æ—¥å‰</option>
            <option value="3hour">3æ™‚é–“å‰</option>
            <option value="1hour">1æ™‚é–“å‰</option>
            <option value="30min">30åˆ†å‰</option>
            <option value="15min">15åˆ†å‰</option>
            <option value="10min">10åˆ†å‰</option>
            <option value="5min">5åˆ†å‰</option>
            <option value="1min">1åˆ†å‰</option>
          </select>
        </div>

        <!-- æœŸé™å‰ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
        <div class="form-group">
          <label>
            <input type="checkbox" formControlName="enableEndReminder"> æœŸé™å‰ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®š
          </label>
        </div>

        <div class="form-group" *ngIf="editForm.get('enableEndReminder')?.value">
          <label for="endReminderType">æœŸé™å‰ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</label>
          <select id="endReminderType" formControlName="endReminderType">
            <option value="1day">1æ—¥å‰</option>
            <option value="3hour">3æ™‚é–“å‰</option>
            <option value="1hour">1æ™‚é–“å‰</option>
            <option value="30min">30åˆ†å‰</option>
            <option value="15min">15åˆ†å‰</option>
            <option value="10min">10åˆ†å‰</option>
            <option value="5min">5åˆ†å‰</option>
            <option value="1min">1åˆ†å‰</option>
          </select>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
        <div class="form-group">
          <label>
            <input type="checkbox" formControlName="enableCustomReminder"> ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®š
          </label>
        </div>

        <div class="form-group" *ngIf="editForm.get('enableCustomReminder')?.value">
          <label for="customReminderDateTime">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æ—¥æ™‚</label>
          <input type="datetime-local" id="customReminderDateTime" formControlName="customReminderDateTime">
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="toggleEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="save-btn">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- æ¬¡ã‚„ã‚‹ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<app-next-task-candidates
  [showModal]="showNextTaskCandidates"
  (closeModal)="showNextTaskCandidates = false">
</app-next-task-candidates>

